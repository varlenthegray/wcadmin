{% load widget_tweaks %}

<div class="card">
    <div class="card-header">
        <div class="btn-group" style="height:20px;padding:0;">
            <button type="button" class="btn btn-primary dropdown-toggle btn-sm px-2 me-2" style="padding:0;" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Job Sites
            </button>

            <span class="badge rounded-pill bg-primary">{{ all_job_sites.count }}</span>
            <div class="vr ms-3 bg-secondary opacity-100"></div>

            <div class="dropdown-menu">
                {% for job_site in all_job_sites %}
                    <button type="button" data-job="{{ job_site.pk }}" class="dropdown-item btn btn-sm btn-primary btn-icon-text job_site_load {% if job_site.pk == job_site_id %}active{% endif %}">
                        <i class="btn-icon-prepend pb-2px fa fa-truck"></i> {{ job_site.name }}
                    </button>
                {% endfor %}
                <div class="dropdown-divider"></div>
                <button type="button" class="dropdown-item btn btn-sm btn-primary btn-icon-text" data-bs-toggle="modal" data-bs-target="#addJobSiteModal">
                    <i class="btn-icon-prepend pb-2px fa fa-plus"></i> Add New Job Site
                </button>
            </div>
        </div>

        <strong class="ms-2 card-title">Viewing: <abbr title="ID: {{ job_site_id }}">{{ jobsite.name.value }}</abbr></strong>
        <button type="button" class="btn btn-link btn-icon float-end" data-bs-toggle="modal" data-bs-target="#addJobSiteModal">
            <i class="fa fa-plus-circle"></i>
        </button>
    </div>

    <div class="card-body" id="jobSiteCard">
        <form method="post" id="jobsiteForm" action="{% url 'updateJobSite' pk=job_site_id %}">
            {% csrf_token %}
            {{ jobsite.non_field_errors }}
            {{ jobsite.edit_job_site }}
            <input type="hidden" value="{{ job_site_id }}" name="job_id" />
            {{ jobsite.customer|attr:"hidden" }}

            {% include 'customer/view_customer/job_site_form.html' %}

            <div class="row" id="jobSiteFormActions" style="display:none;">
                <div class="col-sm-6 offset-sm-6">
                    <button type="submit" class="btn btn-success submit float-end">Update Job Site</button>
                    <button type="reset" class="btn btn-outline-warning float-end mx-2">Reset</button>
                </div>
            </div>
        </form>

        <hr class="bg-secondary opacity-100" />

        <div class="row pt-2 mb-3">
            {% include 'customer/view_customer/job_site_equipment.html' %}
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" id="editProductTag"></div>

<div class="modal" tabindex="-1" id="addJobSiteModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="post" id="addJobSiteCustomerForm" action="{% url 'saveJobSiteToCustomer' %}">
                {% csrf_token %}
                <input type="hidden" value="{{ customer_id }}" name="customer_id" />

                <div class="modal-header">
                    <h5 class="modal-title">Add Job Site to Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="btn-close"></button>
                </div>

                <div class="modal-body">
                    {% include 'customer/view_customer/job_site_form.html' %}
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Job Site</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal" tabindex="-1" id="addEquipmentJobSite">
    {% include 'customer/view_customer/add_equipment_jobsite.html' %}
</div>

<script>
  $(function() {
    $(".job_site_load").on("click", function() {
      window.location.href = "{% url 'viewSpecificJobSite' pk=999999999 %}".replace(/999999999/, $(this).data('job'));
    });

    $("#jobSiteCard").on("click", "#addEquipment", function() {
      $("#addEquipmentJobSite").modal('show');
    });

    $("#jobsiteForm").on("keyup change", function() {
      $("#jobSiteFormActions").show();
    }).on("reset", function() {
      $("#jobSiteFormActions").hide();
    });

    let editEquipmentRowID = null, editEquipmentRow = null;

    $(".editEquipmentRow").on("click", function() {
      editEquipmentRowID = $(this).data('equip-id');
      editEquipmentRow = $(this);
      let call = "{% url 'viewEditEquipmentLine' pk=999999999 %}".replace(/999999999/, editEquipmentRowID);

      $.ajax(call).done(function(response) {
        $("#editProductTag").html(response).modal('show');
      });
    });

    $("#editProductTag").on("click", "#editDeleteEquipment", function() {
      let call = "{% url 'viewJobSiteDeleteEquipment' pk=999999999 %}".replace(/999999999/, editEquipmentRowID);

      $.ajax(call).done(function() {
        editEquipmentRow.parents('tr').html('');

        $("#editProductTag").modal('hide');

        new Noty({
          text: "Successfully deleted equipment and saved Job Site.",
          theme: 'bootstrap-v4',
          type: 'success'
        }).show();
      });
    });

    let addJobSiteModal = document.getElementById('addJobSiteModal');
    addJobSiteModal.addEventListener('shown.bs.modal', function() {
      $(':input','#addJobSiteCustomerForm')
          .not(':button, :submit, :reset, :hidden')
          .val('')
          .prop('checked', false)
          .prop('selected', false);
    });
  });
</script>