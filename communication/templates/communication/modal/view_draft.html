{% load widget_tweaks %}

<div class="modal-dialog modal-xl template_container">
    <div class="modal-content">
        <form method="post">
            {% csrf_token %}

            <div>
                <div class="d-flex align-items-center p-3 border-bottom tx-16">
                    <i class="fa fa-fw fa-file-text-o me-2"></i> Draft
                </div>
            </div>
            <div class="p-3 pb-0">
                <div class="row mb-3">
                    {{ form.send_bcc.errors }}
                    <label class="col-md-2 col-form-label" for="{{ form.send_bcc.id_for_label }}"><abbr title="Not visible to recipients.">BCC</abbr></label>
                    <div class="col-md-10">
                        <select class="compose-multiple-select form-select" name="{{ form.send_bcc.name }}" id="{{ form.send_bcc.id_for_label }}" multiple="multiple" style="width:100%;">
                            {% for customer in customers %}
                                {% if customer.email %}
                                    <option value="{{ customer.name }} <{{ customer.email }}>">{{ customer.name }} ({{ customer.email }})</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    {{ form.send_cc.errors }}
                    <label class="col-md-2 col-form-label" for="{{ form.send_cc.id_for_label }}"><abbr title="Visible to recipients.">CC:</abbr></label>
                    <div class="col-md-10">
                        <select class="compose-multiple-select form-select" name="{{ form.send_cc.name }}" id="{{ form.send_cc.id_for_label }}" multiple="multiple" style="width:100%;">
                            <option value="Dennis Warwick <dennis@wcwater.com>">Dennis Warwick (dennis@wcwater.com)</option>
                            <option value="{% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %} <{{ user.email }}>">{% if user.first_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.username }}{% endif %} ({{ user.email }})</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    {{ form.subject.errors }}
                    <label class="col-md-2 col-form-label" for="{{ form.subject.id_for_label }}">Subject</label>
                    <div class="col-md-10">{{ form.subject|add_class:"form-control" }}</div>
                </div>
                <div class="row mb-3">
                    {{ form.template_used.errors }}
                    <label class="col-md-2 col-form-label" for="{{ form.template_used.id_for_label }}">Template</label>
                    <div class="col-md-10">
                        <select class="compose-multiple-select form-select" name="{{ form.template_used.name }}" id="{{ form.template_used.id_for_label }}" style="width:100%;">
                            <option value="" selected="selected">None</option>
                            {% for template in existing_templates %}
                                <option value="{{ template.pk }}">{{ template.template_name }}</option>
                            {% empty %}
                                <option value="none" selected="selected">No Templates Exist</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="px-3">
                <div class="col-md-12">
                    <div class="mb-3">
                        {{ form.message.errors }}
                        <label class="form-label visually-hidden" for="simpleMdeEditor">Email Body </label>
                        <textarea class="form-control" name="{{ form.message.name }}" id="{{ form.message.id_for_label }}" rows="5">{{ form.message.value }}</textarea>
                    </div>
                </div>
                <div>
                    <div class="col-md-12">
                        <button class="btn btn-success me-1 mb-1 btn-icon-text" type="submit"><i class="fa fa-send-o fa-fw btn-icon-prepend"></i> Send</button>
                        <button class="btn btn-secondary me-1 mb-1 btn-icon-text" id="save_email_draft" type="button"><i class="fa fa-save fa-fw btn-icon-prepend"></i> Save Draft</button>

                        <button class="btn btn-danger me-1 mb-1 btn-icon-text float-end" type="reset"><i class="fa fa-cancel fa-fw btn-icon-prepend"></i> Cancel</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
  $(function() {
    message_mde = wcaSystem.setup_mde_editor('#{{ form.message.id_for_label }}');

    $(".compose-multiple-select").select2({
      dropdownParent: $(".template_container").parent(),
      tags: true,
    });

    $.ajax('{% url 'getEmailHistory' pk=email_pk %}').done(function(data) {
      data = data[0];

      let option = new Option(data.send_bcc, data.id, true, true);
      let select = $("#{{ form.send_bcc.id_for_label }}");

      select.append(option).trigger('change');

      // manually trigger the `select2:select` event
      select.trigger({
        type: 'select2:select',
        params: {
          data: data
        }
      });
    });
  });
</script>